<!DOCTYPE html>

<!-- Great tutorial on mustache.js + node.js: http://devcrapshoot.com/javascript/nodejs-expressjs-and-mustachejs-template-engine -->
<html>

<head>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<title>Minty: Resource Planning extension for GreenHopper</title>

	<style>
		html {
			font-size: 12px;
		}
		body {
			padding: 5px 20px;
		}
		html {
			font-family: Helvetica, sans-serif;
		}
		h1 {
			margin: 0;
		}
		table {
			width: 100%;
		}
		table, th, td {
			border: 1px solid black;
			border-collapse: collapse;
			padding: 5px 5px;
		}
		th {
			position: static;
		}
		tbody tr.include {
			opacity: 1.0;
		}
		tbody tr {
			opacity: 0.3;
		}
	</style>

</head>
<body>

	<h1>Minty: Resource Planning on GreenHopper</h1>

	<h2>Sprint</h2>

	<form>
		<table>
			<thead>
				<tr>
					<th>Type</th>
					<th>Key</th>
					<th>Description</th>
					<th>Release</th>
					<th>Status</th>
					<th>BL</th>
					<th>BO</th>
					<th>BK</th>
					<th>BM</th>
					<th>DW</th>
					<th>KL</th>
					<th>OO</th>
					<th>SH</th>
					<th>SL</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				{{#finalData}}
				<tr>
					<td>{{type}}</td>
					<td>{{key}}</td>
					<td>{{description}}</td>
					<td>{{release}}</td>
					<td>{{status}}</td>
					<td class="BL task">{{BL}}</td>
					<td class="BO task">{{BO}}</td>
					<td class="BK task">{{BK}}</td>
					<td class="BM task">{{BM}}</td>
					<td class="DW task">{{DW}}</td>
					<td class="KL task">{{KL}}</td>
					<td class="OO task">{{OO}}</td>
					<td class="SH task">{{SH}}</td>
					<td class="SL task">{{SL}}</td>
					<td><input type="checkbox" name="" checked="checked"/></td>
				</tr>
				{{/finalData}}
			</tbody>
			<tfoot>
				<tr>
					<th colspan="5"></th>
					<th>BL</th>
					<th>BO</th>
					<th>BK</th>
					<th>BM</th>
					<th>DW</th>
					<th>KL</th>
					<th>OO</th>
					<th>SH</th>
					<th>SL</th>
					<th></th>
				</tr>
				<tr>
					<th colspan="5"></th>
					<th class="BL total"></th>
					<th class="BO total"></th>
					<th class="BK total"></th>
					<th class="BM total"></th>
					<th class="DW total"></th>
					<th class="KL total"></th>
					<th class="OO total"></th>
					<th class="SH total"></th>
					<th class="SL total"></th>
					<th></th>
				</tr>
			</tfoot>
		</table>
	</form>

	<script>
		document.addEventListener("DOMContentLoaded", function init (event) {
			processTable();
			initializeEvents();
		}, false);

		function processTable() {
				console.log(88);
			var doers = ["BL", "BO", "BK", "BM", "DW", "KL", "OO", "SH", "SL"], // HACK!!!
				eTable = document.querySelector("table"),
				eRows = eTable.querySelectorAll("tbody tr"),
				eTasks = null,
				eTotal = null,
				total = 0;

			// Mark selected rows for task addition. First reset checked to empty string.
			for (var k = 0; k < eRows.length; k++) {
				eRows[k].className = "";
				if (eRows[k].querySelector("input[checked=checked")) {
					eRows[k].className = "include";
				}
			}


			// Add hours for each person.
			for (var i = 0; i < doers.length; i++) {
				initials = doers[i];
				eTasks = eTable.querySelectorAll("tr.include " + "." + initials + ".task");
				eTotal = eTable.querySelector("." + initials + ".total");
				total = 0;

				for (var j = 0; j < eTasks.length; j++ ) {
					var estimate = parseInt(eTasks[j].innerHTML);
					if (estimate && !isNaN(estimate)) {
						total += estimate;
					}
				}
				eTotal.innerHTML = total;
			}
		}

		function initializeEvents() {
			var form = document.querySelector("form");
			form.addEventListener("click", initCheckboxes, false);
		}

		function initCheckboxes(event) {
			var element = event.srcElement;
			if (element.getAttribute("type") === "checkbox") {
				if (element.checked) {
					// Note that checkbox.checked is the state after click!
					console.log(element + " is now checked.");
					element.setAttribute("checked", "checked");
				} else {
					console.log(element + "is now unchecked.");
					element.removeAttribute("checked");
				}
				processTable();
			}
		}
			
	</script>

</body>

</html>
