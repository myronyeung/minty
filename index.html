<!DOCTYPE html>

<!-- Great tutorial on mustache.js + node.js: http://devcrapshoot.com/javascript/nodejs-expressjs-and-mustachejs-template-engine -->
<html>

<head>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<title>Minty: Resource Planning Extension For GreenHopper</title>

	<style>
		html {
			font-size: 12px;
		}
		body {
			padding: 5px 20px;
		}
		html {
			font-family: Helvetica, sans-serif;
		}
		h1 {
			margin: 0;
		}
		table {
			width: 100%;
		}
		table, th, td {
			border: 1px solid black;
			border-collapse: collapse;
			padding: 5px 5px;
		}
		tbody tr.include {
			opacity: 1.0;
		}
		tbody tr {
			opacity: 0.3;
		}
		th.fn {
			transform: rotate(-90deg);
		}
		.totals {
			text-align: right;
		}
		.sprintSelect {
			font-size: 1.5rem;
			font-weight: bold;
		}
		.clearBoth {
			clear: both;
		}



		/*
 * ScrumStickies Style Rules
 *
 * @author Myron Yeung
 */

/* For readability, explicitly stating that these styles apply to all devices */
@media all {
	.ticket {
		font-size: 1.25rem;
		font-family: Helvetica, sans-serif;
	}
	.ticket {
		position: relative;
		float: left;
		box-sizing: border-box;
		width: 2.75in;
		height: 2.75in;
		padding: 0.15in;
		list-style-type: none;
	}
	.ticket.Story {
		/* Light yellow */
		background-color: rgba(255, 255, 153, 0.8);
	}
	.ticket.Bug {
		/* Light magenta */
		background-color: rgba(255, 0, 255, 0.3);
	}
	.type {
		margin-bottom: 5px;
	}
	.id {
		font-size: 1.5rem;
		margin-bottom: 10px;
	}
	.description {
		font-size: 1.5rem;
		font-weight: bold;
	}
	.points {
		position: absolute;
		box-sizing: border-box;
		top: .15in;
		right: .15in;
		border: 1px solid black;
		border-radius: .2in;
		width: .4in;
		height: .4in;
		font-size: 1.5rem;
		font-weight: bold;
		text-align: center;
		line-height: .4in;
	}
	.release {
		position: absolute;
		box-sizing: border-box;
		bottom: .15in;
		border: 1px solid black;
		border-radius: .05in;
		width: 1in;
		font-size: 1.25rem;
		text-align: center;
		line-height: .3in;
	}
	.subtasks {
		position: absolute;
		box-sizing: border-box;
		bottom: .15in;
		right: .15in;
		list-style-type: none;
	}
	.subtask {
		font-size: 0.8rem;
		text-align: right;
	}
}

@media screen {
	.ticket {
		margin: .25in;
		border: 1px solid rgba(0, 0, 0, 1.0);
	}
}

@media print {
	.screen {
		display: none;
	}
	.ticket {
		margin: 0;
		border: 1px dashed rgba(0, 0, 0, 0.2);
		page-break-inside: avoid;
	}
}
	</style>

</head>
<body>
	<h1 class="screen">Minty: Resource Planning Extension For GreenHopper</h1>

	<h2>{{finalData.currentSprint}} has {{finalData.currentSprintCount}} items</h2>

	<p>FYI: Currently Minty only displays up to 50 tickets, due to a limitation with the JIRA Rest API</p>

	<form class="screen">
		<table>
			<thead>
				<tr>
					<th>Type</th>
					<th>Key</th>
					<th>Description</th>
					<th>Release</th>
					<th>Status</th>
					{{#people.people}}
					<th class="fn">{{people.fullName}}</th>
					{{/people.people}}
					<th></th>
				</tr>
				<tr>
					<th class="totals" colspan="5">Remaining hours</th>
					{{#people.people}}
					<th class="{{people.fullNameCompact}} total"></th>
					{{/people.people}}
					<th></th>
				</tr>
			</thead>
			<tfoot>
				<tr>
					<th colspan="5"></th>
					{{#people.people}}
					<th class="fn">{{people.fullName}}</th>
					{{/people.people}}
					<th></th>
				</tr>
				<tr>
					<th class="totals" colspan="5">Remaining hours</th>
					{{#people.people}}
					<th class="{{people.fullNameCompact}} total"></th>
					{{/people.people}}
					<th></th>
				</tr>
			</tfoot>
			<tbody>
				{{#finalData}}
				<tr>
					<td>{{type}}</td>
					<td>{{key}}</td>
					<td>{{description}}</td>
					<td>{{release}}</td>
					<td>{{status}}</td>
					<td class="BarryLukens task">{{Barry Lukens}}</td>
					<td class="BryanOstrum task">{{Bryan Ostrum}}</td>
					<td class="BillKocik task">{{Bill Kocik}}</td>
					<td class="BryanMorgan task">{{Bryan Morgan}}</td>
					<td class="DavidWren task">{{David Wren}}</td>
					<td class="JamesCoutry task">{{James Coutry}}</td>
					<td class="JonCampbell task">{{Jon Campbell}}</td>
					<td class="KevinLuman task">{{Kevin Luman}}</td>
					<td class="OliviaOsby task">{{Olivia Osby}}</td>
					<td class="ScottHoffman task">{{Scott Hoffman}}</td>
					<td class="StevenLu task">{{Steven Lu}}</td>
					<td><input type="checkbox" name="" checked="checked"/></td>
				</tr>
				{{/finalData}}
			</tbody>
		</table>
	</form>


	{{#finalData}}
	<ul class="ticket {{type2}}">
		<li class="type">{{type2}}</li>
		<li class="id">{{key}}</li>
		<li class="description">{{description}}</li>
		{{#storyPoints}}<li class="points">{{storyPoints}}</li>{{/storyPoints}}
		<li class="release">{{release2}}</li>
		<li>
			<ul class="subtasks">
				{{#subtasks}}
				<li class="subtask"><span class="fn">{{displayName}}</span>: <span class="estimate">{{estimate}}</span></li>
				{{/subtasks}}
			</ul>
		</li>
	</ul>
	{{/finalData}}

	<div class="hidden clearBoth">
		<section>
			<h2>Text View</h2>
			{{#finalData}}
				<p>{{type}} {{key}} {{description}} {{release}} {{status}} 
					{{#subtasks}}{{displayName}}: {{estimate}}{{^estimate}}N/A{{/estimate}} {{/subtasks}}</p>
			{{/finalData}}
		</section>

		<section>
			<h2>Contributors</h2>
			<ul>
				{{#finalData.sprintContributors}}
				<li>{{.}}</li>
				{{/finalData.sprintContributors}}
			</ul>
		</section>
	</div>

	<script>
		document.addEventListener("DOMContentLoaded", function init (event) {
			initializeSprintSelect();
			processTable();
			initializeEvents();
		}, false);

		function initializeSprintSelect () {
			var sprintSelect = document.querySelector(".sprintSelect");
			if (sprintSelect) {
				sprintSelect.addEventListener("change", selectSprint, false);
			}
		}

		function selectSprint() {

		}

		function processTable() {
			var doers = ["BarryLukens", "BryanOstrum", "BillKocik", "BryanMorgan", "DavidWren", "JamesCoutry", "JonCampbell", "KevinLuman", "OliviaOsby", "ScottHoffman", "StevenLu"], // HACK!!!
				eTable = document.querySelector("table"),
				eRows = eTable.querySelectorAll("tbody tr"),
				eTasks = null,
				eTotal = null,
				total = 0;

			// Mark selected rows for task addition. First reset checked to empty string.
			for (var k = 0; k < eRows.length; k++) {
				eRows[k].className = "";
				if (eRows[k].querySelector("input[checked=checked]")) {
					eRows[k].className = "include";
				}
			}


			// Add hours for each person.
			for (var i = 0; i < doers.length; i++) {
				initials = doers[i];
				eTasks = eTable.querySelectorAll("tr.include " + "." + initials + ".task");
				eTotal = eTable.querySelectorAll("." + initials + ".total");
				total = 0;

				for (var j = 0; j < eTasks.length; j++) {
					var estimate = parseInt(eTasks[j].innerHTML);
					if (estimate && !isNaN(estimate)) {
						total += estimate;
					}
				}

				for (var l = 0; l < eTotal.length; l++) {
					eTotal[l].innerHTML = total;
				}
			}
		}

		function initializeEvents() {
			var form = document.querySelector("form");
			form.addEventListener("click", initCheckboxes, false);
		}

		function initCheckboxes(event) {
			var element = event.srcElement;
			if (element.getAttribute("type") === "checkbox") {
				if (element.checked) {
					// Note that checkbox.checked is the state after click!
					console.log(element + " is now checked.");
					element.setAttribute("checked", "checked");
				} else {
					console.log(element + "is now unchecked.");
					element.removeAttribute("checked");
				}
				processTable();
			}
		}
			
	</script>

</body>

</html>

