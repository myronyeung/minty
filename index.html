<!DOCTYPE html>

<!-- Great tutorial on mustache.js + node.js: http://devcrapshoot.com/javascript/nodejs-expressjs-and-mustachejs-template-engine -->
<html>

<head>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<title>Minty: Resource Planning Extension For GreenHopper</title>

	<style>
		html {
			font-size: 12px;
		}
		body {
			padding: 5px 20px;
		}
		html {
			font-family: Helvetica, sans-serif;
		}
		h1 {
			margin: 0;
		}
		table {
			width: 100%;
		}
		table, th, td {
			border: 1px solid black;
			border-collapse: collapse;
			padding: 5px 5px;
		}
		tbody tr.include {
			opacity: 1.0;
		}
		tbody tr {
			opacity: 0.3;
		}
		.totals {
			text-align: right;
		}
		.sprintSelect {
			font-size: 1.5rem;
			font-weight: bold;
		}



		/*
 * ScrumStickies Style Rules
 *
 * @author Myron Yeung
 */

/* For readability, explicitly stating that these styles apply to all devices */
@media all {
	.ticket {
		font-size: 1.25rem;
		font-family: Helvetica, sans-serif;
	}
	.ticket {
		position: relative;
		float: left;
		box-sizing: border-box;
		width: 2.75in;
		height: 2.75in;
		padding: 0.15in;
		list-style-type: none;
	}
	.ticket.Story {
		/* Light yellow */
		background-color: rgba(255, 255, 153, 0.8);
	}
	.ticket.Bug {
		/* Light magenta */
		background-color: rgba(255, 0, 255, 0.3);
	}
	.type {
		margin-bottom: 5px;
	}
	.id {
		font-size: 1.5rem;
		margin-bottom: 10px;
	}
	.description {
		font-size: 1.5rem;
		font-weight: bold;
	}
	.points {
		position: absolute;
		box-sizing: border-box;
		top: .15in;
		right: .15in;
		border: 1px solid black;
		border-radius: .2in;
		width: .4in;
		height: .4in;
		font-size: 1.5rem;
		font-weight: bold;
		text-align: center;
		line-height: .4in;
	}
	.release {
		position: absolute;
		box-sizing: border-box;
		bottom: .15in;
		border: 1px solid black;
		border-radius: .05in;
		width: 1in;
		font-size: 1.25rem;
		text-align: center;
		line-height: .3in;
	}
	.subtasks {
		position: absolute;
		box-sizing: border-box;
		bottom: .15in;
		right: .15in;
		list-style-type: none;
	}
	.subtask {
		font-size: 0.8rem;
		text-align: right;
	}
}

@media screen {
	.ticket {
		margin: .25in;
		border: 1px solid rgba(0, 0, 0, 1.0);
	}
}

@media print {
	.screen {
		display: none;
	}
	.ticket {
		margin: 0;
		border: 1px dashed rgba(0, 0, 0, 0.2);
		page-break-inside: avoid;
	}
}
	</style>

</head>
<body>
	<h1 class="screen">Minty: Resource Planning Extension For GreenHopper</h1>

	<h2>{{finalData.currentSprint}}</h2>

	<form class="screen">
		<table>
			<thead>
				<tr>
					<th>Type</th>
					<th>Key</th>
					<th>Description</th>
					<th>Release</th>
					<th>Status</th>
					<th>BL</th>
					<th>BO</th>
					<th>BK</th>
					<th>BM</th>
					<th>DW</th>
					<th>KL</th>
					<th>OO</th>
					<th>SH</th>
					<th>SL</th>
					<th></th>
				</tr>
				<tr>
					<th class="totals" colspan="5">Remaining hours</th>
					<th class="BL total"></th>
					<th class="BO total"></th>
					<th class="BK total"></th>
					<th class="BM total"></th>
					<th class="DW total"></th>
					<th class="KL total"></th>
					<th class="OO total"></th>
					<th class="SH total"></th>
					<th class="SL total"></th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				{{#finalData}}
				<tr>
					<td>{{type}}</td>
					<td>{{key}}</td>
					<td>{{description}}</td>
					<td>{{release}}</td>
					<td>{{status}}</td>
					<td class="BL task">{{BL}}</td>
					<td class="BO task">{{BO}}</td>
					<td class="BK task">{{BK}}</td>
					<td class="BM task">{{BM}}</td>
					<td class="DW task">{{DW}}</td>
					<td class="KL task">{{KL}}</td>
					<td class="OO task">{{OO}}</td>
					<td class="SH task">{{SH}}</td>
					<td class="SL task">{{SL}}</td>
					<td><input type="checkbox" name="" checked="checked"/></td>
				</tr>
				{{/finalData}}
			</tbody>
			<tfoot>
				<tr>
					<th colspan="5"></th>
					<th>BL</th>
					<th>BO</th>
					<th>BK</th>
					<th>BM</th>
					<th>DW</th>
					<th>KL</th>
					<th>OO</th>
					<th>SH</th>
					<th>SL</th>
					<th></th>
				</tr>
				<tr>
					<th class="totals" colspan="5">Remaining hours</th>
					<th class="BL total"></th>
					<th class="BO total"></th>
					<th class="BK total"></th>
					<th class="BM total"></th>
					<th class="DW total"></th>
					<th class="KL total"></th>
					<th class="OO total"></th>
					<th class="SH total"></th>
					<th class="SL total"></th>
					<th></th>
				</tr>
			</tfoot>
		</table>
	</form>


	{{#finalData}}
	<ul class="ticket {{type2}}">
		<li class="type">{{type2}}</li>
		<li class="id">{{key}}</li>
		<li class="description">{{description}}</li>
		{{#storyPoints}}<li class="points">{{storyPoints}}</li>{{/storyPoints}}
		<li class="release">{{release2}}</li>
		<li>
			<ul class="subtasks">
				{{#subtasks}}
				<li class="subtask"><span class="fn">{{name}}</span>: <span class="estimate">{{estimate}}</span></li>
				{{!<li class="subtask"><span class="fn">Barry Lucky</span>: <span class="estimate">12h</span></li>}}
				{{/subtasks}}
			</ul>
		</li>
	</ul>
	{{/finalData}}


	<script>
		document.addEventListener("DOMContentLoaded", function init (event) {
			initializeSprintSelect();
			processTable();
			initializeEvents();
		}, false);

		function initializeSprintSelect () {
			var sprintSelect = document.querySelector(".sprintSelect");
			if (sprintSelect) {
				sprintSelect.addEventListener("change", selectSprint, false);
			}
		}

		function selectSprint() {

		}

		function processTable() {
			var doers = ["BL", "BO", "BK", "BM", "DW", "KL", "OO", "SH", "SL"], // HACK!!!
				eTable = document.querySelector("table"),
				eRows = eTable.querySelectorAll("tbody tr"),
				eTasks = null,
				eTotal = null,
				total = 0;

			// Mark selected rows for task addition. First reset checked to empty string.
			for (var k = 0; k < eRows.length; k++) {
				eRows[k].className = "";
				if (eRows[k].querySelector("input[checked=checked]")) {
					eRows[k].className = "include";
				}
			}


			// Add hours for each person.
			for (var i = 0; i < doers.length; i++) {
				initials = doers[i];
				eTasks = eTable.querySelectorAll("tr.include " + "." + initials + ".task");
				eTotal = eTable.querySelectorAll("." + initials + ".total");
				total = 0;

				for (var j = 0; j < eTasks.length; j++) {
					var estimate = parseInt(eTasks[j].innerHTML);
					if (estimate && !isNaN(estimate)) {
						total += estimate;
					}
				}

				for (var l = 0; l < eTotal.length; l++) {
					eTotal[l].innerHTML = total;
				}
			}
		}

		function initializeEvents() {
			var form = document.querySelector("form");
			form.addEventListener("click", initCheckboxes, false);
		}

		function initCheckboxes(event) {
			var element = event.srcElement;
			if (element.getAttribute("type") === "checkbox") {
				if (element.checked) {
					// Note that checkbox.checked is the state after click!
					console.log(element + " is now checked.");
					element.setAttribute("checked", "checked");
				} else {
					console.log(element + "is now unchecked.");
					element.removeAttribute("checked");
				}
				processTable();
			}
		}
			
	</script>

</body>

</html>
