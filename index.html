<!DOCTYPE html>

<!-- Great tutorial on mustache.js + node.js: http://devcrapshoot.com/javascript/nodejs-expressjs-and-mustachejs-template-engine -->
<html>

<head>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<title>Minty: Resource Planning Extension For GreenHopper</title>

	<style>
		html {
			font-size: 12px;
		}
		body {
			padding: 5px 20px;
		}
		html {
			font-family: Helvetica, sans-serif;
		}
		h1 {
			margin: 0;
		}
		table {
			width: 100%;
		}
		table, th, td {
			border: 1px solid black;
			border-collapse: collapse;
			padding: 5px 5px;
		}
		tbody tr.include {
			opacity: 1.0;
		}
		tbody tr {
			opacity: 0.3;
		}
		th.fn {
			transform: rotate(-90deg);
		}
		.totals {
			text-align: right;
		}
		.sprintSelect {
			font-size: 1.5rem;
			font-weight: bold;
		}
		.clearBoth {
			clear: both;
		}



		/*
 * ScrumStickies Style Rules
 *
 * @author Myron Yeung
 */

/* For readability, explicitly stating that these styles apply to all devices */
@media all {
	.ticket {
		font-size: 1.25rem;
		font-family: Helvetica, sans-serif;
	}
	.ticket {
		position: relative;
		float: left;
		box-sizing: border-box;
		width: 2.75in;
		height: 2.75in;
		padding: 0.15in;
		list-style-type: none;
	}
	.ticket.Story {
		/* Light yellow */
		background-color: rgba(255, 255, 153, 0.8);
	}
	.ticket.Bug {
		/* Light magenta */
		background-color: rgba(255, 0, 255, 0.3);
	}
	.type {
		margin-bottom: 5px;
	}
	.id {
		font-size: 1.5rem;
		margin-bottom: 10px;
	}
	.description {
		font-size: 1.5rem;
		font-weight: bold;
	}
	.points {
		position: absolute;
		box-sizing: border-box;
		top: .15in;
		right: .15in;
		border: 1px solid black;
		border-radius: .2in;
		width: .4in;
		height: .4in;
		font-size: 1.5rem;
		font-weight: bold;
		text-align: center;
		line-height: .4in;
	}
	.release {
		position: absolute;
		box-sizing: border-box;
		bottom: .15in;
		border: 1px solid black;
		border-radius: .05in;
		width: 1in;
		font-size: 1.25rem;
		text-align: center;
		line-height: .3in;
	}
	.subtasks {
		position: absolute;
		box-sizing: border-box;
		bottom: .15in;
		right: .15in;
		list-style-type: none;
	}
	.subtask {
		font-size: 0.8rem;
		text-align: right;
	}
}

@media screen {
	.ticket {
		margin: .25in;
		border: 1px solid rgba(0, 0, 0, 1.0);
	}
}

@media print {
	.screen {
		display: none;
	}
	.ticket {
		margin: 0;
		border: 1px dashed rgba(0, 0, 0, 0.2);
		page-break-inside: avoid;
	}
}
	</style>

</head>
<body>
	<h1 class="screen">Minty: Resource Planning Extension For GreenHopper</h1>

	<h2>{{sprint.id}} has {{sprint.total}} items</h2>

	<p>FYI: Currently Minty only displays up to 50 tickets, due to a limitation with the JIRA Rest API. I will deal with this later.</p>

	<form class="screen">
		<table>
			<thead>
				<tr>
					<th>Type</th>
					<th>Story Points</th>
					<th>Key</th>
					<th>Description</th>
					<th>Release</th>
					<th>Status</th>
					{{#sprint.contributors}}
					<th class="fn">{{.}}</th>
					{{/sprint.contributors}}
					<th></th>
				</tr>
				<tr>
					<th class="totals" colspan="6">Remaining hours</th>
					{{#sprint.contributors}}
					<th class="{{.}} total">{{.}}</th>
					{{/sprint.contributors}}
					<th></th>
				</tr>
			</thead>
			<tfoot>
				<tr>
					<th colspan="6"></th>
					{{#sprint.contributors}}
					<th class="fn">{{.}}</th>
					{{/sprint.contributors}}
					<th></th>
				</tr>
				<tr>
					<th class="totals" colspan="6">Remaining hours</th>
					{{#sprint.contributors}}
					<th class="{{.}} total">{{.}}</th>
					{{/sprint.contributors}}
					<th></th>
				</tr>
			</tfoot>
			<tbody>
				{{#sprint.issues}}
				<tr>
					<td>{{type}}</td>
					<td>{{storyPoints}}</td>
					<td>{{key}}</td>
					<td>{{summary}}</td>
					<td>{{#fixVersions}}{{.}} {{/fixVersions}}</td>
					<td>{{status}}</td>
					{{#subtasks}}
					<td class="{{name}} task">{{remainingEstimateHours}}</td>
					{{/subtasks}}
					<td><input type="checkbox" name="" checked="checked"/></td>
				</tr>
				{{/sprint.issues}}
			</tbody>
		</table>
	</form>


	{{#sprint.issues}}
	<ul class="ticket {{fields.issuetype.name}}">
		<li class="type">{{fields.issuetype.name}}</li>
		<li class="id">{{key}}</li>
		<li class="description">{{fields.summary}}</li>
		{{#fields.customfield_10002}}<li class="points">{{fields.customfield_10002}}</li>{{/fields.customfield_10002}}
		{{#fields.fixVersions}}<li class="release">{{name}}</li>{{/fields.fixVersions}}
		<li>
			<ul class="subtasks">
				{{#fields.subtasks}}
				<li class="subtask">
					<span class="fn">{{subtask.fields.assignee.displayName}}</span>: 
					<span class="estimate">
						{{subtask.fields.timetracking.remainingEstimate}}
						{{^subtask.fields.timetracking.remainingEstimate}}TBD{{/subtask.fields.timetracking.remainingEstimate}}
					</span>
				</li>
				{{/fields.subtasks}}
			</ul>
		</li>
	</ul>
	{{/sprint.issues}}

	<div class="hidden clearBoth">
		<section>
			<h2>Text View</h2>
			{{#sprint.issues}}
				<p>
					{{fields.issuetype.name}} {{fields.customfield_10002}} {{key}} {{fields.summary}} 
					{{#fields.fixVersions}}{{name}}{{/fields.fixVersions}} {{fields.status.name}} 
					{{#fields.subtasks}}
						{{subtask.fields.assignee.displayName}}: 
						{{subtask.fields.timetracking.remainingEstimate}}
						{{^subtask.fields.timetracking.remainingEstimate}}TBD{{/subtask.fields.timetracking.remainingEstimate}}
					{{/fields.subtasks}}
				</p>
			{{/sprint.issues}}


			{{#sprint}}
				<p>{{type}} {{key}} {{description}} {{release}} {{status}} 
					{{#subtasks}}{{displayName}}: {{estimate}}{{^estimate}}TBD{{/estimate}} {{/subtasks}}</p>
			{{/sprint}}
		</section>

		<section>
			<h2>Contributors</h2>
			<ul>
				{{#sprint.contributors}}
				<li>{{.}}</li>
				{{/sprint.contributors}}
			</ul>
		</section>
	</div>

	<script>
		document.addEventListener("DOMContentLoaded", function init (event) {
			initializeSprintSelect();
			processTable();
			initializeEvents();
		}, false);

		function initializeSprintSelect () {
			var sprintSelect = document.querySelector(".sprintSelect");
			if (sprintSelect) {
				sprintSelect.addEventListener("change", selectSprint, false);
			}
		}

		function selectSprint() {

		}

		function processTable() {
			// I do not like the trailing comma in doers. mustache.js is a little too logic-less.
			var doers = [{{#sprint.contributors}}"{{.}}", {{/sprint.contributors}}],
				eTable = document.querySelector("table"),
				eRows = eTable.querySelectorAll("tbody tr"),
				eTasks = null,
				eTotal = null,
				total = 0;

			// Mark selected rows for task addition. First reset checked to empty string.
			for (var k = 0; k < eRows.length; k++) {
				eRows[k].className = "";
				if (eRows[k].querySelector("input[checked=checked]")) {
					eRows[k].className = "include";
				}
			}


			// Add hours for each person.
			for (var i = 0; i < doers.length; i++) {
				initials = doers[i];
				eTasks = eTable.querySelectorAll("tr.include " + "." + initials + ".task");
				eTotal = eTable.querySelectorAll("." + initials + ".total");
				total = 0;

				for (var j = 0; j < eTasks.length; j++) {
					var estimate = parseInt(eTasks[j].innerHTML);
					if (estimate && !isNaN(estimate)) {
						total += estimate;
					}
				}

				for (var l = 0; l < eTotal.length; l++) {
					eTotal[l].innerHTML = total;
				}
			}
		}

		function initializeEvents() {
			var form = document.querySelector("form");
			form.addEventListener("click", initCheckboxes, false);
		}

		function initCheckboxes(event) {
			var element = event.srcElement;
			if (element.getAttribute("type") === "checkbox") {
				if (element.checked) {
					// Note that checkbox.checked is the state after click!
					console.log(element + " is now checked.");
					element.setAttribute("checked", "checked");
				} else {
					console.log(element + "is now unchecked.");
					element.removeAttribute("checked");
				}
				processTable();
			}
		}
			
	</script>

</body>

</html>
